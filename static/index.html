<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Direct Line Streaming — Web Chat</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        #chatContainer {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #webchat {
            flex: 1 1 auto;
        }

        #controls {
            padding: 10px;
            background: #f3f3f3;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="chatContainer">
        <div id="controls">
            <button id="btnStart">Start / Reconnect</button>
            <span id="status">Status: idle</span>
        </div>
        <div id="webchat" role="main"></div>
    </div>

    <!-- Web Chat CDN (latest stable) -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

    <script>
        // Replace this with your server endpoint that returns a Direct Line token (POST).
        // Example: POST /directline/token  -> returns JSON: { "token": "YOUR_DIRECT_LINE_TOKEN" }
        const DIRECTLINE_TOKEN_ENDPOINT = '/directline/token';

        const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
            // You can intercept actions here (optional)
            return next(action);
        });

        const startWebChat = async () => {
            document.getElementById('status').innerText = 'Status: requesting token...';

            // Request Direct Line token from your server
            const res = await fetch(DIRECTLINE_TOKEN_ENDPOINT, { method: 'POST' });
            if (!res.ok) {
                document.getElementById('status').innerText = `Status: token request failed (${res.status})`;
                console.error('Token request failed:', await res.text());
                return;
            }

            const json = await res.json();
            const directLineToken = json.token;
            if (!directLineToken) {
                document.getElementById('status').innerText = 'Status: no token in response';
                console.error('No token in response', json);
                return;
            }

            document.getElementById('status').innerText = 'Status: token obtained — connecting...';

            // Create DirectLine object with WebSocket support (streaming)
            const directLine = window.WebChat.createDirectLine({
                token: directLineToken,
                webSocket: true // enable streaming via WebSocket
            });

            // Optional: attach event listeners for connection status
            directLine.connectionStatus$.subscribe(status => {
                // connectionStatus codes: 0=Uninitialized,1=Connecting,2=Online,3=ExpiredToken,4=FailedToConnect,5=Ended
                const statusMap = {
                    0: 'Uninitialized',
                    1: 'Connecting',
                    2: 'Online',
                    3: 'Expired token',
                    4: 'Failed to connect',
                    5: 'Ended'
                };
                document.getElementById('status').innerText = `Status: ${statusMap[status] || status}`;
            });

            // Render Web Chat
            window.WebChat.renderWebChat({
                directLine,
                userID: 'dl_user_' + Math.floor(Math.random() * 1000000),
                username: 'Web Chat User',
                store,
                // Enable speech or other features here if you want (but keep simple for now)
                sendTyping: true,
                styleOptions: {
                    botAvatarInitials: 'AI',
                    userAvatarInitials: 'You'
                }
            }, document.getElementById('webchat'));

            // Focus input
            document.querySelector('#webchat [role="textbox"]')?.focus();

            // Optional: send an initial message to bot (kickoff)
            // directLine.postActivity({ from: { id: 'dl_user_1' }, type: 'message', text: 'Hello' }).subscribe(
            //   id => console.log('Posted message, id:', id),
            //   error => console.error('Post activity error', error)
            // );

            document.getElementById('status').innerText = 'Status: connected (streaming)';
        };

        // Start / reconnect button
        document.getElementById('btnStart').addEventListener('click', async () => {
            // Clear previous webchat container
            document.getElementById('webchat').innerHTML = '';
            await startWebChat();
        });

        // Auto-start
        startWebChat().catch(err => {
            console.error(err);
            document.getElementById('status').innerText = 'Status: error starting chat';
        });
    </script>
</body>

</html>