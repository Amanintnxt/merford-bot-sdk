<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Direct Line Streaming — Web Chat</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex flex-col h-screen font-sans">

    <!-- Header -->
    <header class="bg-blue-600 text-white py-3 px-4 shadow-md flex justify-between items-center">
        <h1 class="text-lg font-semibold">💬 Bot Chat</h1>
        <span id="status" class="text-sm bg-blue-500 px-3 py-1 rounded-full">Status: idle</span>
    </header>

    <!-- Chat container -->
    <main id="chatContainer"
        class="flex-1 flex flex-col max-w-3xl w-full mx-auto bg-white shadow-lg border rounded-b-lg overflow-hidden">

        <!-- Controls -->
        <div id="controls" class="p-3 border-b flex gap-3 bg-gray-50">
            <button id="btnStart"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                🔄 Start / Reconnect
            </button>
        </div>

        <!-- WebChat UI Box -->
        <div id="webchat" class="flex-1 overflow-hidden"></div>
    </main>

    <!-- Microsoft BotFramework WebChat -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

    <script>
        const DIRECTLINE_TOKEN_ENDPOINT = '/directline/token';

        const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
            return next(action);
        });

        const startWebChat = async () => {
            document.getElementById('status').innerText = 'Status: requesting token...';

            try {
                const res = await fetch(DIRECTLINE_TOKEN_ENDPOINT, { method: 'POST' });
                if (!res.ok) {
                    document.getElementById('status').innerText = `Status: token request failed (${res.status})`;
                    console.error('Token request failed:', await res.text());
                    return;
                }

                const json = await res.json();
                const directLineToken = json.token;
                if (!directLineToken) {
                    document.getElementById('status').innerText = 'Status: no token in response';
                    console.error('No token in response', json);
                    return;
                }

                document.getElementById('status').innerText = 'Status: token obtained — connecting...';

                const directLine = window.WebChat.createDirectLine({
                    token: directLineToken,
                    webSocket: true
                });

                directLine.connectionStatus$.subscribe(status => {
                    const statusMap = {
                        0: 'Uninitialized',
                        1: 'Connecting',
                        2: 'Online ✅',
                        3: 'Expired token',
                        4: 'Failed to connect ❌',
                        5: 'Ended'
                    };
                    document.getElementById('status').innerText = `Status: ${statusMap[status] || status}`;
                });

                window.WebChat.renderWebChat({
                    directLine,
                    userID: 'dl_user_' + Math.floor(Math.random() * 1000000),
                    username: 'Web Chat User',
                    store,
                    sendTyping: true,
                    styleOptions: {
                        botAvatarInitials: 'AI',
                        userAvatarInitials: 'You',
                        backgroundColor: '#ffffff'
                    }
                }, document.getElementById('webchat'));

                document.querySelector('#webchat [role="textbox"]')?.focus();
            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = 'Status: error starting chat';
            }
        };

        document.getElementById('btnStart').addEventListener('click', async () => {
            document.getElementById('webchat').innerHTML = '';
            await startWebChat();
        });

        startWebChat();
    </script>
</body>

</html>